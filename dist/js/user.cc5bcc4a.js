"use strict";(self["webpackChunkwavetune"]=self["webpackChunkwavetune"]||[]).push([[806],{4597:function(e,a,t){t.r(a),t.d(a,{default:function(){return R}});t(4114),t(8111),t(2489);var r=t(6768),l=t(4232),s=t(144),o=t(1387),d=t(8148),n=t(5720),i=t(1219),u=t(2933);const c={class:"user-feedback-view"},p={class:"top-section"},m={class:"avatar-section"},f={style:{"margin-top":"12px"}},b={class:"user-name"},k={class:"status-normal"},g={class:"status-primary"},_={class:"rating-section"},v={class:"action-buttons"},w={key:0,class:"history-section"},h={class:"history-item",style:{padding:"12px","border-radius":"8px",background:"#f9f9f9"}},F={class:"history-header",style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"10px"}},y={style:{display:"flex","align-items":"center",gap:"12px"}},L={style:{display:"flex","align-items":"center",gap:"16px"}},C={class:"history-content",style:{padding:"8px",background:"#fff","border-radius":"4px"}},V={key:1,class:"history-empty",style:{"margin-top":"24px",padding:"24px"}};var S={__name:"UserFeedbackView",setup(e){(0,o.rd)();const a=(0,s.KR)(null),t=(0,s.Kh)({type:"accuracy",content:"",rating:3}),S={type:[{required:!0,message:"请选择反馈类型",trigger:"change"}],content:[{required:!0,message:"请输入反馈内容",trigger:"blur"},{min:10,message:"反馈内容至少10个字符",trigger:"blur"}]},x=(0,s.Kh)({avatar:null,name:"",student_id:"",create_time:"",detection_count:0,intervention_count:0}),W=(0,s.KR)([]),R=()=>{try{const e=JSON.parse(window.localStorage.getItem("user")||"null");e&&(x.avatar=e.avatar||"/static/avatar/default.jpg",x.name=e.username||e.name||"",x.student_id=e.student_id||"",x.create_time=e.create_time||"",x.detection_count=e.detection_count||0,x.intervention_count=e.intervention_count||0)}catch(e){console.error("加载用户信息失败:",e)}},U=e=>{if(!e)return"—";try{const a=new Date(e);return a.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch(a){return e}},E=async()=>{try{let a=null;try{const e=JSON.parse(window.localStorage.getItem("user")||"null");e&&e.id&&(a=e.id)}catch(e){console.error("获取用户ID失败:",e)}if(!a)return void(W.value=[]);const t=await n.f.get("/feedback/history",{user_id:a,page:1,page_size:20});W.value=t.data?.list||[]}catch(e){console.error("获取历史反馈失败:",e)}},I=async()=>{try{await a.value.validate()}catch(l){return}let e=null;try{const a=JSON.parse(window.localStorage.getItem("user")||"null");a&&a.id&&(e=a.id)}catch(s){console.error("获取用户ID失败:",s)}if(!e)return void i.nk.error("请先登录后再提交反馈");const r={user_id:e,feedback_type:t.type,content:t.content.trim(),score:t.rating};try{await n.f.post("/feedback/submit",r),i.nk.success("反馈已提交，感谢您的建议"),await E(),t.content="",t.rating=3,t.type="accuracy";try{window.dispatchEvent(new Event("feedback-changed"))}catch(s){}}catch(s){console.error("提交反馈失败:",s)}},B=async e=>{try{const t=JSON.parse(window.localStorage.getItem("user")||"null");if(!t||!t.id)return void i.nk.error("请先登录");await u.s.confirm("确认删除这条反馈吗？此操作不可恢复","删除反馈",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"});const r=await n.f.delete(`/feedback/${e}`,{user_id:t.id});if(r&&200===r.code){i.nk.success("删除成功"),W.value=W.value.filter(a=>a.id!==e);try{window.dispatchEvent(new Event("feedback-changed"))}catch(a){}}else i.nk.error(r?.msg||"删除失败")}catch(a){if(a&&a.message&&a.message.includes("取消"))return;console.error("删除反馈失败:",a),i.nk.error("删除失败")}},K=()=>{t.content="",t.rating=3,t.type="accuracy",a.value&&a.value.clearValidate()};return(0,r.sV)(()=>{R(),window.addEventListener("auth-changed",R),E()}),(0,r.xo)(()=>{window.removeEventListener("auth-changed",R)}),(e,s)=>{const o=(0,r.g2)("el-page-header"),n=(0,r.g2)("el-avatar"),i=(0,r.g2)("el-button"),u=(0,r.g2)("el-descriptions-item"),R=(0,r.g2)("el-descriptions"),E=(0,r.g2)("el-col"),T=(0,r.g2)("el-radio"),z=(0,r.g2)("el-radio-group"),X=(0,r.g2)("el-form-item"),A=(0,r.g2)("el-input"),P=(0,r.g2)("el-rate"),O=(0,r.g2)("el-form"),M=(0,r.g2)("el-tag"),$=(0,r.g2)("el-timeline-item"),D=(0,r.g2)("el-timeline"),j=(0,r.g2)("el-empty"),q=(0,r.g2)("el-row");return(0,r.uX)(),(0,r.CE)("div",c,[s[17]||(s[17]=(0,r.Lk)("div",{class:"wave-background"},[(0,r.Lk)("div",{class:"wave wave-1"}),(0,r.Lk)("div",{class:"wave wave-2"}),(0,r.Lk)("div",{class:"wave wave-3"})],-1)),(0,r.Lk)("div",p,[(0,r.bF)(o,{content:"用户信息与反馈",class:"page-header"},{extra:(0,r.k6)(()=>[...s[5]||(s[5]=[(0,r.Lk)("div",{class:"header-divider"},null,-1)])]),_:1})]),(0,r.bF)(q,{gutter:20,class:"main-section"},{default:(0,r.k6)(()=>[(0,r.bF)(E,{xs:24,sm:24,md:8,lg:8,xl:8},{default:(0,r.k6)(()=>[(0,r.bF)(d.A,{title:"个人信息",class:"user-info-card"},{default:(0,r.k6)(()=>[(0,r.Lk)("div",m,[(0,r.bF)(n,{size:100,src:x.avatar||"/static/avatar/default.jpg",class:"user-avatar"},null,8,["src"]),(0,r.Lk)("div",f,(0,l.v_)(x.name||"未登录"),1),(0,r.bF)(i,{type:"text",class:"change-avatar-btn",onClick:s[0]||(s[0]=a=>e.$router.push("/user-center"))},{default:(0,r.k6)(()=>[...s[6]||(s[6]=[(0,r.eW)(" 更换头像 ",-1)])]),_:1})]),(0,r.bF)(R,{column:1,class:"user-descriptions"},{default:(0,r.k6)(()=>[(0,r.bF)(u,{label:"姓名"},{default:(0,r.k6)(()=>[(0,r.Lk)("span",b,(0,l.v_)(x.name||"—"),1)]),_:1}),(0,r.bF)(u,{label:"学号"},{default:(0,r.k6)(()=>[(0,r.eW)((0,l.v_)(x.student_id||"—"),1)]),_:1}),(0,r.bF)(u,{label:"注册"},{default:(0,r.k6)(()=>[(0,r.eW)((0,l.v_)(x.create_time?U(x.create_time):"—"),1)]),_:1}),(0,r.bF)(u,{label:"检测"},{default:(0,r.k6)(()=>[(0,r.Lk)("span",k,(0,l.v_)(x.detection_count||0)+" 次",1)]),_:1}),(0,r.bF)(u,{label:"干预"},{default:(0,r.k6)(()=>[(0,r.Lk)("span",g,(0,l.v_)(x.intervention_count||0)+" 次",1)]),_:1})]),_:1}),s[7]||(s[7]=(0,r.Lk)("div",{class:"info-notice"}," 以上信息仅用于系统数据关联，不会对外泄露 ",-1))]),_:1})]),_:1}),(0,r.bF)(E,{xs:24,sm:24,md:16,lg:16,xl:16},{default:(0,r.k6)(()=>[(0,r.bF)(d.A,{title:"系统使用反馈",class:"feedback-form-card"},{default:(0,r.k6)(()=>[(0,r.bF)(O,{ref_key:"feedbackFormRef",ref:a,model:t,rules:S,"label-width":"100px",class:"feedback-form"},{default:(0,r.k6)(()=>[(0,r.bF)(X,{label:"反馈类型",prop:"type"},{default:(0,r.k6)(()=>[(0,r.bF)(z,{modelValue:t.type,"onUpdate:modelValue":s[1]||(s[1]=e=>t.type=e)},{default:(0,r.k6)(()=>[(0,r.bF)(T,{label:"accuracy"},{default:(0,r.k6)(()=>[...s[8]||(s[8]=[(0,r.eW)("脑疲劳检测准确性",-1)])]),_:1}),(0,r.bF)(T,{label:"music"},{default:(0,r.k6)(()=>[...s[9]||(s[9]=[(0,r.eW)("轻音乐推荐效果",-1)])]),_:1}),(0,r.bF)(T,{label:"function"},{default:(0,r.k6)(()=>[...s[10]||(s[10]=[(0,r.eW)("系统功能建议",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),(0,r.bF)(X,{label:"反馈内容",prop:"content"},{default:(0,r.k6)(()=>[(0,r.bF)(A,{modelValue:t.content,"onUpdate:modelValue":s[2]||(s[2]=e=>t.content=e),type:"textarea",rows:5,placeholder:"请详细描述您的体验或建议（最多 500 字）",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1}),(0,r.bF)(X,{label:"满意度评分",prop:"rating"},{default:(0,r.k6)(()=>[(0,r.Lk)("div",_,[s[11]||(s[11]=(0,r.Lk)("p",{class:"rating-title"},"对系统的满意度",-1)),(0,r.bF)(P,{modelValue:t.rating,"onUpdate:modelValue":s[3]||(s[3]=e=>t.rating=e),max:5},null,8,["modelValue"])])]),_:1}),(0,r.bF)(X,{class:"form-actions"},{default:(0,r.k6)(()=>[(0,r.Lk)("div",v,[(0,r.bF)(i,{onClick:K},{default:(0,r.k6)(()=>[...s[12]||(s[12]=[(0,r.eW)("取消",-1)])]),_:1}),(0,r.bF)(i,{type:"primary",onClick:I},{default:(0,r.k6)(()=>[...s[13]||(s[13]=[(0,r.eW)("提交反馈",-1)])]),_:1})])]),_:1})]),_:1},8,["model"]),W.value.length?((0,r.uX)(),(0,r.CE)("div",w,[s[15]||(s[15]=(0,r.Lk)("h4",null,"历史反馈",-1)),(0,r.bF)(D,null,{default:(0,r.k6)(()=>[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(W.value,e=>((0,r.uX)(),(0,r.Wv)($,{key:e.id,timestamp:e.submit_time},{default:(0,r.k6)(()=>[(0,r.Lk)("div",h,[(0,r.Lk)("div",F,[(0,r.Lk)("div",y,[(0,r.Lk)("strong",null,(0,l.v_)(x.name||"匿名"),1),(0,r.bF)(M,{size:"small"},{default:(0,r.k6)(()=>[(0,r.eW)((0,l.v_)(e.feedback_type_name||"其他"),1)]),_:2},1024)]),(0,r.Lk)("div",L,[(0,r.bF)(P,{"model-value":e.score,max:5,disabled:""},null,8,["model-value"]),(0,r.bF)(i,{type:"danger",size:"mini",onClick:a=>B(e.id)},{default:(0,r.k6)(()=>[...s[14]||(s[14]=[(0,r.eW)("删除",-1)])]),_:1},8,["onClick"])])]),(0,r.Lk)("div",C,(0,l.v_)(e.content),1)])]),_:2},1032,["timestamp"]))),128))]),_:1})])):((0,r.uX)(),(0,r.CE)("div",V,[(0,r.bF)(j,{description:"还没有历史反馈"},{footer:(0,r.k6)(()=>[(0,r.bF)(i,{type:"primary",onClick:s[4]||(s[4]=a=>e.$refs.feedbackFormRef?.scrollIntoView?.()||e.window.scrollTo({top:0,behavior:"smooth"}))},{default:(0,r.k6)(()=>[...s[16]||(s[16]=[(0,r.eW)("去提交第一个反馈",-1)])]),_:1})]),_:1})]))]),_:1})]),_:1})]),_:1}),s[18]||(s[18]=(0,r.Lk)("div",{class:"bottom-section"},[(0,r.Lk)("div",{class:"feedback-notice"},[(0,r.Lk)("p",null,"反馈提交后，我们将在 3 个工作日内评估并回复；若需紧急支持，请通过以下方式联系我们："),(0,r.Lk)("p",null,[(0,r.eW)("邮箱："),(0,r.Lk)("a",{href:"mailto:help@wavetune.example"},"help@wavetune.com"),(0,r.eW)(" ｜ QQ 群：12345678")]),(0,r.Lk)("p",null,[(0,r.eW)("常见问题："),(0,r.Lk)("a",{href:"/help/faq",target:"_blank"},"查看 FAQ")])])],-1))])}}},x=t(1241);const W=(0,x.A)(S,[["__scopeId","data-v-5f16712f"]]);var R=W},8148:function(e,a,t){t.d(a,{A:function(){return m}});var r=t(6768),l=t(4232);const s={class:"card-header"},o={key:0,class:"card-actions"},d={key:1,class:"card-footer"},n={key:2,class:"wave-decoration"};function i(e,a,t,i,u,c){const p=(0,r.g2)("el-card");return(0,r.uX)(),(0,r.Wv)(p,{class:(0,l.C4)(["modern-card",{"wave-card":t.waveStyle,"gradient-border":t.gradientBorder,"glow-effect":t.glowEffect,compact:t.compact},t.customClass]),shadow:i.shadowLevel},(0,r.eX)({default:(0,r.k6)(()=>[t.showHeaderBar||t.waveStyle?((0,r.uX)(),(0,r.CE)("div",{key:0,class:"card-header-bar",style:(0,l.Tr)(i.headerBarStyle)},null,4)):(0,r.Q3)("",!0),(0,r.Lk)("div",{class:"card-content",style:(0,l.Tr)({padding:t.contentPadding})},[(0,r.RG)(e.$slots,"default",{},void 0,!0)],4),e.$slots.footer?((0,r.uX)(),(0,r.CE)("div",d,[(0,r.RG)(e.$slots,"footer",{},void 0,!0)])):(0,r.Q3)("",!0),t.waveStyle?((0,r.uX)(),(0,r.CE)("div",n,[...a[0]||(a[0]=[(0,r.Lk)("svg",{viewBox:"0 0 1440 320",xmlns:"http://www.w3.org/2000/svg"},[(0,r.Lk)("path",{fill:"currentColor","fill-opacity":"0.08",d:"M0,160L60,170.7C120,181,240,203,360,186.7C480,171,600,117,720,112C840,107,960,149,1080,176C1200,203,1320,213,1380,218.7L1440,224L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"})],-1)])])):(0,r.Q3)("",!0)]),_:2},[t.title||e.$slots.header?{name:"header",fn:(0,r.k6)(()=>[(0,r.Lk)("div",s,[(0,r.RG)(e.$slots,"header",{},()=>[(0,r.Lk)("h3",{class:(0,l.C4)(["card-title",{"title-gradient":t.gradientTitle,"title-large":"large"===t.titleSize,"title-medium":"medium"===t.titleSize,"title-small":"small"===t.titleSize}])},(0,l.v_)(t.title),3)],!0),e.$slots.actions?((0,r.uX)(),(0,r.CE)("div",o,[(0,r.RG)(e.$slots,"actions",{},void 0,!0)])):(0,r.Q3)("",!0)])]),key:"0"}:void 0]),1032,["class","shadow"])}var u={name:"CardContainer",props:{title:{type:String,default:""},shadow:{type:String,default:"hover"},customClass:{type:String,default:""},waveStyle:{type:Boolean,default:!1},gradientBorder:{type:Boolean,default:!1},glowEffect:{type:Boolean,default:!1},compact:{type:Boolean,default:!1},showHeaderBar:{type:Boolean,default:!0},gradientTitle:{type:Boolean,default:!1},titleSize:{type:String,default:"medium",validator:e=>["small","medium","large"].includes(e)},contentPadding:{type:String,default:"24px"},headerBarColor:{type:String,default:""}},setup(e){const a=(0,r.EW)(()=>{switch(e.shadow){case"none":return"none";case"always":return"always";case"hover":default:return"hover"}}),t=(0,r.EW)(()=>e.headerBarColor?{backgroundColor:e.headerBarColor}:{});return{shadowLevel:a,headerBarStyle:t}}},c=t(1241);const p=(0,c.A)(u,[["render",i],["__scopeId","data-v-611ccd8c"]]);var m=p},8722:function(e,a,t){t.r(a),t.d(a,{default:function(){return L}});var r=t(6768),l=t(4232);const s={class:"user-center"},o={class:"user-center-container"},d={class:"card-header"},n={class:"user-info-content"},i={class:"avatar-section"},u={class:"card-header"},c={class:"card-header"},p={key:0,class:"feedback-form-container"},m={class:"feedback-content"};function f(e,a,t,f,b,k){const g=(0,r.g2)("el-button"),_=(0,r.g2)("User"),v=(0,r.g2)("el-icon"),w=(0,r.g2)("el-avatar"),h=(0,r.g2)("Upload"),F=(0,r.g2)("el-upload"),y=(0,r.g2)("el-input"),L=(0,r.g2)("el-form-item"),C=(0,r.g2)("el-col"),V=(0,r.g2)("el-row"),S=(0,r.g2)("el-form"),x=(0,r.g2)("el-card"),W=(0,r.g2)("el-option"),R=(0,r.g2)("el-select"),U=(0,r.g2)("el-switch"),E=(0,r.g2)("el-table-column"),I=(0,r.g2)("el-tag"),B=(0,r.g2)("el-table");return(0,r.uX)(),(0,r.CE)("div",s,[a[36]||(a[36]=(0,r.Lk)("div",{class:"wave-background"},[(0,r.Lk)("div",{class:"wave wave-1"}),(0,r.Lk)("div",{class:"wave wave-2"}),(0,r.Lk)("div",{class:"wave wave-3"})],-1)),(0,r.Lk)("div",o,[(0,r.bF)(x,{class:"user-info-card",shadow:"hover"},{header:(0,r.k6)(()=>[(0,r.Lk)("div",d,[a[20]||(a[20]=(0,r.Lk)("h2",null,"个人信息",-1)),(0,r.bF)(g,{type:"primary",onClick:a[0]||(a[0]=e=>f.editMode=!f.editMode)},{default:(0,r.k6)(()=>[(0,r.eW)((0,l.v_)(f.editMode?"取消编辑":"编辑资料"),1)]),_:1})])]),default:(0,r.k6)(()=>[(0,r.Lk)("div",n,[(0,r.Lk)("div",i,[(0,r.bF)(w,{size:120,src:f.userInfo.avatar||"/static/avatar/default.jpg",class:"user-avatar"},{default:(0,r.k6)(()=>[(0,r.bF)(v,null,{default:(0,r.k6)(()=>[(0,r.bF)(_)]),_:1})]),_:1},8,["src"]),f.editMode?((0,r.uX)(),(0,r.Wv)(F,{key:0,class:"avatar-uploader","show-file-list":!1,"before-upload":f.beforeAvatarUpload,"http-request":f.uploadAvatar},{default:(0,r.k6)(()=>[(0,r.bF)(g,{type:"primary",size:"small",class:"upload-btn"},{default:(0,r.k6)(()=>[(0,r.bF)(v,null,{default:(0,r.k6)(()=>[(0,r.bF)(h)]),_:1}),a[21]||(a[21]=(0,r.eW)(" 更换头像 ",-1))]),_:1})]),_:1},8,["before-upload","http-request"])):(0,r.Q3)("",!0)]),(0,r.bF)(S,{ref:"userFormRef",model:f.userForm,rules:f.userRules,"label-width":"100px",class:"user-form"},{default:(0,r.k6)(()=>[(0,r.bF)(V,{gutter:20},{default:(0,r.k6)(()=>[(0,r.bF)(C,{span:12},{default:(0,r.k6)(()=>[(0,r.bF)(L,{label:"用户名",prop:"username"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{modelValue:f.userForm.username,"onUpdate:modelValue":a[1]||(a[1]=e=>f.userForm.username=e),disabled:!f.editMode,placeholder:"请输入用户名"},null,8,["modelValue","disabled"])]),_:1})]),_:1}),(0,r.bF)(C,{span:12},{default:(0,r.k6)(()=>[(0,r.bF)(L,{label:"学号",prop:"student_id"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{modelValue:f.userForm.student_id,"onUpdate:modelValue":a[2]||(a[2]=e=>f.userForm.student_id=e),disabled:!f.editMode,placeholder:"请输入学号"},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),(0,r.bF)(V,{gutter:20},{default:(0,r.k6)(()=>[(0,r.bF)(C,{span:12},{default:(0,r.k6)(()=>[(0,r.bF)(L,{label:"邮箱",prop:"email"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{modelValue:f.userForm.email,"onUpdate:modelValue":a[3]||(a[3]=e=>f.userForm.email=e),disabled:!f.editMode,placeholder:"请输入邮箱"},null,8,["modelValue","disabled"])]),_:1})]),_:1}),(0,r.bF)(C,{span:12},{default:(0,r.k6)(()=>[(0,r.bF)(L,{label:"手机号",prop:"phone"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{modelValue:f.userForm.phone,"onUpdate:modelValue":a[4]||(a[4]=e=>f.userForm.phone=e),disabled:!f.editMode,placeholder:"请输入手机号"},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),(0,r.bF)(V,{gutter:20},{default:(0,r.k6)(()=>[(0,r.bF)(C,{span:12},{default:(0,r.k6)(()=>[(0,r.bF)(L,{label:"检测次数"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{value:f.userInfo.detection_count,disabled:""},null,8,["value"])]),_:1})]),_:1}),(0,r.bF)(C,{span:12},{default:(0,r.k6)(()=>[(0,r.bF)(L,{label:"干预次数"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{value:f.userInfo.intervention_count,disabled:""},null,8,["value"])]),_:1})]),_:1})]),_:1}),(0,r.bF)(V,{gutter:20},{default:(0,r.k6)(()=>[(0,r.bF)(C,{span:12},{default:(0,r.k6)(()=>[(0,r.bF)(L,{label:"注册时间"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{value:f.formatDate(f.userInfo.create_time),disabled:""},null,8,["value"])]),_:1})]),_:1}),(0,r.bF)(C,{span:12},{default:(0,r.k6)(()=>[(0,r.bF)(L,{label:"最后登录"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{value:f.formatDate(f.userInfo.last_login_time),disabled:""},null,8,["value"])]),_:1})]),_:1})]),_:1}),f.editMode?((0,r.uX)(),(0,r.Wv)(L,{key:0},{default:(0,r.k6)(()=>[(0,r.bF)(g,{type:"primary",loading:f.updateLoading,onClick:f.handleUpdateProfile},{default:(0,r.k6)(()=>[...a[22]||(a[22]=[(0,r.eW)(" 保存修改 ",-1)])]),_:1},8,["loading","onClick"]),(0,r.bF)(g,{onClick:f.resetForm},{default:(0,r.k6)(()=>[...a[23]||(a[23]=[(0,r.eW)("重置",-1)])]),_:1},8,["onClick"])]),_:1})):(0,r.Q3)("",!0)]),_:1},8,["model","rules"])])]),_:1}),(0,r.bF)(x,{class:"preferences-card",shadow:"hover"},{header:(0,r.k6)(()=>[...a[24]||(a[24]=[(0,r.Lk)("h2",null,"偏好设置",-1)])]),default:(0,r.k6)(()=>[(0,r.bF)(S,{ref:"preferencesFormRef",model:f.preferencesForm,"label-width":"120px",class:"preferences-form"},{default:(0,r.k6)(()=>[(0,r.bF)(L,{label:"默认疲劳等级"},{default:(0,r.k6)(()=>[(0,r.bF)(R,{modelValue:f.preferencesForm.default_fatigue_level,"onUpdate:modelValue":a[5]||(a[5]=e=>f.preferencesForm.default_fatigue_level=e),onChange:a[6]||(a[6]=e=>f.updatePreference("default_fatigue_level",e))},{default:(0,r.k6)(()=>[(0,r.bF)(W,{label:"轻度疲劳",value:"light"}),(0,r.bF)(W,{label:"中度疲劳",value:"medium"}),(0,r.bF)(W,{label:"重度疲劳",value:"heavy"})]),_:1},8,["modelValue"])]),_:1}),(0,r.bF)(L,{label:"偏好音乐类型"},{default:(0,r.k6)(()=>[(0,r.bF)(R,{modelValue:f.preferencesForm.preferred_music_type,"onUpdate:modelValue":a[7]||(a[7]=e=>f.preferencesForm.preferred_music_type=e),onChange:a[8]||(a[8]=e=>f.updatePreference("preferred_music_type",e))},{default:(0,r.k6)(()=>[(0,r.bF)(W,{label:"自然音效",value:"natural"}),(0,r.bF)(W,{label:"钢琴音乐",value:"piano"}),(0,r.bF)(W,{label:"白噪音",value:"whitenoise"}),(0,r.bF)(W,{label:"混合音乐",value:"mix"})]),_:1},8,["modelValue"])]),_:1}),(0,r.bF)(L,{label:"通知设置"},{default:(0,r.k6)(()=>[(0,r.bF)(U,{modelValue:f.preferencesForm.notification_enabled,"onUpdate:modelValue":a[9]||(a[9]=e=>f.preferencesForm.notification_enabled=e),"active-text":"开启","inactive-text":"关闭",onChange:a[10]||(a[10]=e=>f.updatePreference("notification_enabled",e?"true":"false"))},null,8,["modelValue"])]),_:1}),(0,r.bF)(L,{label:"自动播放"},{default:(0,r.k6)(()=>[(0,r.bF)(U,{modelValue:f.preferencesForm.auto_play,"onUpdate:modelValue":a[11]||(a[11]=e=>f.preferencesForm.auto_play=e),"active-text":"开启","inactive-text":"关闭",onChange:a[12]||(a[12]=e=>f.updatePreference("auto_play",e?"true":"false"))},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1}),(0,r.bF)(x,{class:"sessions-card",shadow:"hover"},{header:(0,r.k6)(()=>[(0,r.Lk)("div",u,[a[26]||(a[26]=(0,r.Lk)("h2",null,"会话管理",-1)),(0,r.bF)(g,{type:"danger",onClick:f.handleLogoutAll},{default:(0,r.k6)(()=>[...a[25]||(a[25]=[(0,r.eW)(" 退出所有设备 ",-1)])]),_:1},8,["onClick"])])]),default:(0,r.k6)(()=>[(0,r.bF)(B,{data:f.sessions,style:{width:"100%"}},{default:(0,r.k6)(()=>[(0,r.bF)(E,{prop:"device_display",label:"设备信息"}),(0,r.bF)(E,{prop:"ip_address",label:"IP地址"}),(0,r.bF)(E,{prop:"create_time",label:"登录时间"},{default:(0,r.k6)(({row:e})=>[(0,r.eW)((0,l.v_)(f.formatDate(e.create_time)),1)]),_:1}),(0,r.bF)(E,{prop:"last_activity",label:"最后活动"},{default:(0,r.k6)(({row:e})=>[(0,r.eW)((0,l.v_)(f.formatDate(e.last_activity)),1)]),_:1}),(0,r.bF)(E,{label:"操作"},{default:(0,r.k6)(({row:e})=>[e.id!==f.currentSessionId?((0,r.uX)(),(0,r.Wv)(g,{key:0,type:"danger",size:"small",onClick:a=>f.handleRevokeSession(e.id)},{default:(0,r.k6)(()=>[...a[27]||(a[27]=[(0,r.eW)(" 撤销 ",-1)])]),_:1},8,["onClick"])):((0,r.uX)(),(0,r.Wv)(I,{key:1,type:"success",size:"small"},{default:(0,r.k6)(()=>[...a[28]||(a[28]=[(0,r.eW)("当前会话",-1)])]),_:1}))]),_:1})]),_:1},8,["data"])]),_:1}),(0,r.bF)(x,{class:"feedback-card",shadow:"hover"},{header:(0,r.k6)(()=>[(0,r.Lk)("div",c,[a[30]||(a[30]=(0,r.Lk)("h2",null,"历史反馈",-1)),(0,r.bF)(g,{type:"primary",size:"small",onClick:a[13]||(a[13]=e=>f.showFeedbackForm=!f.showFeedbackForm)},{default:(0,r.k6)(()=>[...a[29]||(a[29]=[(0,r.eW)(" 提交新反馈 ",-1)])]),_:1})])]),default:(0,r.k6)(()=>[f.showFeedbackForm?((0,r.uX)(),(0,r.CE)("div",p,[(0,r.bF)(S,{ref:"feedbackFormRef",model:f.feedbackForm,"label-width":"100px",class:"feedback-form"},{default:(0,r.k6)(()=>[(0,r.bF)(L,{label:"反馈类型"},{default:(0,r.k6)(()=>[(0,r.bF)(R,{modelValue:f.feedbackForm.type,"onUpdate:modelValue":a[14]||(a[14]=e=>f.feedbackForm.type=e)},{default:(0,r.k6)(()=>[(0,r.bF)(W,{label:"功能建议",value:"suggestion"}),(0,r.bF)(W,{label:"问题反馈",value:"bug"}),(0,r.bF)(W,{label:"其他",value:"other"})]),_:1},8,["modelValue"])]),_:1}),(0,r.bF)(L,{label:"反馈内容"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{modelValue:f.feedbackForm.content,"onUpdate:modelValue":a[15]||(a[15]=e=>f.feedbackForm.content=e),type:"textarea",rows:"4",placeholder:"请输入您的反馈内容"},null,8,["modelValue"])]),_:1}),(0,r.bF)(L,null,{default:(0,r.k6)(()=>[(0,r.bF)(g,{type:"primary",onClick:f.handleSubmitFeedback},{default:(0,r.k6)(()=>[...a[31]||(a[31]=[(0,r.eW)("提交",-1)])]),_:1},8,["onClick"]),(0,r.bF)(g,{onClick:a[16]||(a[16]=e=>f.showFeedbackForm=!1)},{default:(0,r.k6)(()=>[...a[32]||(a[32]=[(0,r.eW)("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model"])])):(0,r.Q3)("",!0),(0,r.bF)(B,{data:f.feedbackList,style:{width:"100%"},class:"feedback-table"},{default:(0,r.k6)(()=>[(0,r.bF)(E,{prop:"feedback_type",label:"反馈类型"},{default:(0,r.k6)(({row:e})=>[(0,r.bF)(I,{type:f.getFeedbackTypeTag(e.feedback_type)},{default:(0,r.k6)(()=>[(0,r.eW)((0,l.v_)(f.getFeedbackTypeText(e.feedback_type)),1)]),_:2},1032,["type"])]),_:1}),(0,r.bF)(E,{prop:"content",label:"反馈内容"},{default:(0,r.k6)(({row:e})=>[(0,r.Lk)("div",m,(0,l.v_)(e.content),1)]),_:1}),(0,r.bF)(E,{prop:"submit_time",label:"提交时间"},{default:(0,r.k6)(({row:e})=>[(0,r.eW)((0,l.v_)(f.formatDate(e.submit_time)),1)]),_:1}),(0,r.bF)(E,{prop:"status",label:"处理状态"},{default:(0,r.k6)(({row:e})=>[(0,r.bF)(I,{type:"processed"===e.status?"success":"info"},{default:(0,r.k6)(()=>[(0,r.eW)((0,l.v_)("processed"===e.status?"已处理":"待处理"),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])]),_:1}),(0,r.bF)(x,{class:"password-card",shadow:"hover"},{header:(0,r.k6)(()=>[...a[33]||(a[33]=[(0,r.Lk)("h2",null,"修改密码",-1)])]),default:(0,r.k6)(()=>[(0,r.bF)(S,{ref:"passwordFormRef",model:f.passwordForm,rules:f.passwordRules,"label-width":"100px",class:"password-form"},{default:(0,r.k6)(()=>[(0,r.bF)(L,{label:"原密码",prop:"old_password"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{modelValue:f.passwordForm.old_password,"onUpdate:modelValue":a[17]||(a[17]=e=>f.passwordForm.old_password=e),type:"password",placeholder:"请输入原密码","show-password":""},null,8,["modelValue"])]),_:1}),(0,r.bF)(L,{label:"新密码",prop:"new_password"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{modelValue:f.passwordForm.new_password,"onUpdate:modelValue":a[18]||(a[18]=e=>f.passwordForm.new_password=e),type:"password",placeholder:"请输入新密码","show-password":""},null,8,["modelValue"])]),_:1}),(0,r.bF)(L,{label:"确认密码",prop:"confirm_password"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{modelValue:f.passwordForm.confirm_password,"onUpdate:modelValue":a[19]||(a[19]=e=>f.passwordForm.confirm_password=e),type:"password",placeholder:"请再次输入新密码","show-password":""},null,8,["modelValue"])]),_:1}),(0,r.bF)(L,null,{default:(0,r.k6)(()=>[(0,r.bF)(g,{type:"primary",loading:f.passwordLoading,onClick:f.handleChangePassword},{default:(0,r.k6)(()=>[...a[34]||(a[34]=[(0,r.eW)(" 修改密码 ",-1)])]),_:1},8,["loading","onClick"]),(0,r.bF)(g,{onClick:f.resetPasswordForm},{default:(0,r.k6)(()=>[...a[35]||(a[35]=[(0,r.eW)("重置",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["model","rules"])]),_:1})])])}t(4114),t(8111),t(116),t(1701);var b=t(144),k=t(1387),g=t(1219),_=t(2933),v=t(5720),w=t(7477),h={name:"UserCenterView",components:{User:w.User,Upload:w.Upload},setup(){const e=(0,k.rd)(),a=(0,b.KR)(),t=(0,b.KR)(),l=(0,b.KR)(),s=(0,b.KR)({}),o=(0,b.KR)(!1),d=(0,b.KR)(!1),n=(0,b.KR)(!1),i=(0,b.Kh)({username:"",student_id:"",email:"",phone:""}),u=(0,b.Kh)({default_fatigue_level:"medium",preferred_music_type:"natural",notification_enabled:!0,auto_play:!1}),c=(0,b.Kh)({old_password:"",new_password:"",confirm_password:""}),p=(0,b.KR)([]),m=(0,b.KR)(null),f={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:2,max:50,message:"用户名长度在 2 到 50 个字符",trigger:"blur"}],student_id:[{required:!0,message:"请输入学号",trigger:"blur"},{min:1,max:20,message:"学号长度在 1 到 20 个字符",trigger:"blur"}],email:[{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],phone:[{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号格式",trigger:"blur"}]},w={old_password:[{required:!0,message:"请输入原密码",trigger:"blur"}],new_password:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,max:50,message:"密码长度在 6 到 50 个字符",trigger:"blur"}],confirm_password:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(e,a,t)=>{a!==c.new_password?t(new Error("两次输入密码不一致")):t()},trigger:"blur"}]},h=()=>{const e=localStorage.getItem("user");if(e)try{return JSON.parse(e).id}catch{return 1}return 1},F=async()=>{try{const e=h(),a=await v.f.get("/auth/profile",{user_id:e});a&&200===a.code&&(s.value=a.data,Object.assign(i,{username:a.data.username,student_id:a.data.student_id,email:a.data.email||"",phone:a.data.phone||""}),a.data.preferences&&Object.assign(u,{default_fatigue_level:a.data.preferences.default_fatigue_level||"medium",preferred_music_type:a.data.preferences.preferred_music_type||"natural",notification_enabled:"true"===a.data.preferences.notification_enabled,auto_play:"true"===a.data.preferences.auto_play}))}catch(e){console.error("获取用户信息失败:",e),g.nk.error("获取用户信息失败")}},y=async()=>{try{const e=h(),a=await v.f.get("/auth/sessions",{user_id:e});if(a&&200===a.code){p.value=a.data.sessions;const e=localStorage.getItem("session_token"),t=p.value.find(a=>a.session_token===e);t&&(m.value=t.id)}}catch(e){console.error("获取会话列表失败:",e)}},L=async()=>{if(a.value)try{try{await a.value.validate()}catch(e){return}d.value=!0;const r=h(),l={};let s;void 0!==i.username&&""!==String(i.username).trim()&&(l.username=String(i.username).trim()),void 0!==i.email&&""!==String(i.email).trim()&&(l.email=String(i.email).trim()),void 0!==i.phone&&""!==String(i.phone).trim()&&(l.phone=String(i.phone).trim());try{s=await v.f.put("/auth/profile",l,{user_id:r})}catch(t){const e=t.response?.data||t.response?.data?.detail;if(console.error("更新用户资料失败 (后端):",t,e),e&&e.detail){const a=Array.isArray(e.detail)?e.detail.map(e=>e.msg).join("; "):String(e.detail);g.nk.error(a||"更新失败，数据校验未通过")}else t.response?.data?.msg?g.nk.error(t.response.data.msg):g.nk.error(t.message||"更新失败，请稍后重试");return}if(s&&200===s.code){g.nk.success("资料更新成功");try{localStorage.setItem("user",JSON.stringify(s.data))}catch(e){}try{window.dispatchEvent(new Event("auth-changed"))}catch(e){}o.value=!1,await F()}else g.nk.error(s?.msg||"更新失败")}catch(r){console.error("更新用户资料失败:",r),g.nk.error("更新失败，请稍后重试")}finally{d.value=!1}},C=async(e,a)=>{try{const t=h(),r=await v.f.put("/auth/preference",{preference_key:e,preference_value:a},{user_id:t});r&&200===r.code?g.nk.success("偏好设置已更新"):g.nk.error(r?.msg||"更新失败")}catch(t){console.error("更新偏好设置失败:",t),g.nk.error("更新失败，请稍后重试")}},V=async()=>{if(l.value)try{const e=await l.value.validate();if(!e)return;n.value=!0;const a=h(),t=await v.f.post("/auth/change-password",{old_password:c.old_password,new_password:c.new_password},{user_id:a});t&&200===t.code?(g.nk.success("密码修改成功"),E()):g.nk.error(t?.msg||"修改失败")}catch(e){console.error("修改密码失败:",e),g.nk.error("修改失败，请稍后重试")}finally{n.value=!1}},S=async e=>{try{await _.s.confirm("确定要撤销此会话吗？","确认撤销",{type:"warning",confirmButtonText:"确认",cancelButtonText:"取消"});const a=h(),t=await v.f.delete(`/auth/session/${e}`,{user_id:a});t&&200===t.code?(g.nk.success("会话已撤销"),await y()):g.nk.error(t?.msg||"撤销失败")}catch(a){"cancel"!==a&&(console.error("撤销会话失败:",a),g.nk.error("撤销失败，请稍后重试"))}},x=async()=>{try{await _.s.confirm("确定要退出所有设备吗？","确认退出",{type:"warning",confirmButtonText:"确认",cancelButtonText:"取消"}),g.nk.success("已退出所有设备"),localStorage.removeItem("session_token"),localStorage.removeItem("user");try{window.dispatchEvent(new Event("auth-changed"))}catch(a){}e.push("/login")}catch(t){"cancel"!==t&&console.error("退出所有设备失败:",t)}},W=e=>{const a=e.type.startsWith("image/"),t=e.size/1024/1024<2;return a?!!t||(g.nk.error("图片大小不能超过 2MB!"),!1):(g.nk.error("只能上传图片文件!"),!1)},R=async e=>{try{const t=new FormData;t.append("avatar",e.file),t.append("user_id",String(h()));const r=await v.f.postForm("/user/avatar/upload",t);if(r&&200===r.code){g.nk.success("头像上传成功"),s.value.avatar=r.data.avatar_url;try{localStorage.setItem("user",JSON.stringify(Object.assign({},JSON.parse(localStorage.getItem("user")||"{}"),{avatar:r.data.avatar_url})))}catch(a){}try{window.dispatchEvent(new Event("auth-changed"))}catch(a){}}else g.nk.error(r?.msg||"上传失败")}catch(t){console.error("头像上传失败:",t),g.nk.error("上传失败，请稍后重试")}},U=()=>{Object.assign(i,{username:s.value.username,student_id:s.value.student_id,email:s.value.email||"",phone:s.value.phone||""})},E=()=>{Object.assign(c,{old_password:"",new_password:"",confirm_password:""})},I=e=>e?new Date(e).toLocaleString("zh-CN"):"-",B=(0,b.KR)(),K=(0,b.KR)(!1),T=(0,b.Kh)({type:"suggestion",content:""}),z=(0,b.KR)([]),X=(0,b.KR)(1),A=(0,b.KR)(20),P=async(e=1)=>{try{const a=h(),t=await v.f.get("/feedback/history",{user_id:a,page:e,page_size:A.value});t&&200===t.code&&(z.value=t.data.list||[],X.value=t.data.page||e)}catch(a){console.error("获取历史反馈失败:",a),g.nk.error("获取历史反馈失败")}},O=e=>{const a={accuracy:"primary",music:"success",function:"warning",suggestion:"primary",bug:"danger",other:"warning"};return a[e]||"info"},M=e=>{const a={accuracy:"检测准确性",music:"音乐推荐",function:"系统建议",suggestion:"功能建议",bug:"问题反馈",other:"其他"};return a[e]||e||"未知类型"},$=async()=>{try{const e=h(),a={user_id:e,feedback_type:T.type,content:T.content,score:0},t=await v.f.post("/feedback/submit",a);t&&200===t.code?(g.nk.success("反馈提交成功"),K.value=!1,T.type="suggestion",T.content="",await P(1)):g.nk.error(t?.msg||"提交失败")}catch(e){console.error("提交反馈失败:",e),g.nk.error("提交反馈失败")}};return(0,r.sV)(()=>{F(),y(),P()}),{userFormRef:a,preferencesFormRef:t,passwordFormRef:l,feedbackFormRef:B,userInfo:s,editMode:o,updateLoading:d,passwordLoading:n,userForm:i,preferencesForm:u,passwordForm:c,sessions:p,currentSessionId:m,showFeedbackForm:K,feedbackForm:T,feedbackList:z,userRules:f,passwordRules:w,handleUpdateProfile:L,updatePreference:C,handleChangePassword:V,handleRevokeSession:S,handleLogoutAll:x,beforeAvatarUpload:W,uploadAvatar:R,resetForm:U,resetPasswordForm:E,formatDate:I,getFeedbackTypeTag:O,getFeedbackTypeText:M,handleSubmitFeedback:$}}},F=t(1241);const y=(0,F.A)(h,[["render",f],["__scopeId","data-v-41c31a35"]]);var L=y}}]);
//# sourceMappingURL=user.cc5bcc4a.js.map