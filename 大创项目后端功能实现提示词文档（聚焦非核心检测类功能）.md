# WaveTune 后端功能实现文档（基于现有Vue前端项目）

## 文档说明

本文档基于已完成的 **WaveTune 脑疲劳检测与音乐干预系统** Vue 3 前端项目，聚焦实现支撑前端交互的后端功能。系统采用 **Python FastAPI + MySQL** 技术栈，实现用户信息管理、反馈提交、轻音乐推荐、场景配置等核心功能，确保与前端 Element Plus 组件和 Pinia 状态管理无缝对接。

### 前端项目分析
- **技术栈**: Vue 3 + Element Plus + Pinia + Vue Router
- **主要页面**: 首页、检测结果、音乐推荐、信号监测、联邦学习、个人中心
- **核心功能**: 脑疲劳检测结果展示、个性化音乐推荐、多模态信号监测、联邦学习参与、用户反馈管理
- **数据需求**: 用户信息、音乐数据、反馈记录、场景配置、系统统计

## 一、后端基础环境搭建（支撑所有功能模块）

### 提示词 1：后端项目初始化与数据库设计

#### 功能定位

搭建后端项目基础框架，设计支撑用户信息、反馈、音乐、场景功能的数据库表结构，配置跨域与请求响应格式，确保与前端 Vue 3 项目无缝通信。

#### 技术要求

- 核心框架：FastAPI（优先，支持自动生成接口文档）或 Flask；数据库：MySQL 8.0（或 SQLite 用于本地测试）；ORM 工具：SQLAlchemy（简化数据库操作）。
- 跨域配置：允许前端项目域名（如 `http://localhost:5173`）访问，支持 `GET`/`POST`/`PUT`/`DELETE` 方法；响应格式统一为 `{"code": 200/400/500, "msg": "提示信息", "data": {}}`。

#### 详细实现需求

1. 项目初始化：
   - 输出项目目录结构（`main.py` 入口文件、`models/` 数据库模型、`routers/` 接口路由、`config/` 配置文件、`utils/` 工具函数）。
   - 配置数据库连接：在 `config/db.py` 中定义数据库 URL（区分开发 / 测试环境），使用 SQLAlchemy 创建数据库引擎与会话；配置跨域（FastAPI 用 `CORSMiddleware`，Flask 用 `flask-cors`）。
2. 数据库表设计（5 张核心表，支撑前端所有功能）：
   - **user 表**（用户信息）：字段 `id`（主键，自增）、`username`（用户名，非空）、`student_id`（学号，唯一）、`avatar`（头像路径，默认空）、`detection_count`（检测次数，默认 0）、`intervention_count`（干预次数，默认 0）、`create_time`（注册时间，默认当前时间）、`update_time`（更新时间，自动更新）。
   - **feedback 表**（用户反馈）：字段 `id`（主键）、`user_id`（外键，关联 user 表）、`feedback_type`（反馈类型：accuracy/music/function，对应前端单选值）、`content`（反馈内容，非空，10-500字）、`score`（满意度评分：1-5）、`submit_time`（提交时间，默认当前时间）。
   - **music 表**（轻音乐数据）：字段 `id`（主键）、`title`（音乐标题，非空）、`artist`（艺术家/创作者）、`duration`（时长，如 "05:30"）、`cover`（封面图URL）、`reason`（推荐理由）、`music_type`（音乐类型：natural/piano/whitenoise/mix）、`fatigue_level`（适配疲劳等级：light/medium/heavy，用逗号分隔多值）、`match_rate`（匹配度，1-100）。
   - **scene 表**（场景配置）：字段 `id`（主键）、`user_id`（外键，关联 user 表）、`scene_name`（场景名称，非空，用户唯一）、`music_type`（关联音乐类型，如 "piano"）、`create_time`（创建时间）、`is_default`（是否默认场景：0 - 用户自定义 / 1 - 系统默认，默认 0）。
   - **system_stats 表**（系统统计）：字段 `id`（主键）、`stat_name`（统计名称）、`stat_value`（统计值）、`stat_unit`（单位）、`update_time`（更新时间）。
3. 初始化数据：
   - 向 music 表插入 8-10 条模拟数据（覆盖不同疲劳等级与音乐类型，匹配前端 MusicRecommendationView 的静态数据）
   - 向 scene 表插入 3 条系统默认场景（学习场景：piano、办公场景：whitenoise、休息场景：natural）
   - 向 system_stats 表插入首页统计数据（检测次数、干预次数、参与设备、模型准确率）
   - 向 user 表插入测试用户数据（李同学，学号2022001001）

#### 输出限制

- 输出项目初始化代码（`main.py` 入口、数据库配置、跨域配置）、5 张表的 SQLAlchemy 模型代码（`models/` 下 5 个文件）、数据库初始化脚本（创建表 + 插入默认数据）。
- 不涉及复杂业务逻辑，仅完成基础环境与数据结构搭建，接口文档配置（FastAPI 启用 `/docs` 接口文档）。

## 二、首页统计数据接口实现

### 提示词 2：首页统计数据接口实现

#### 功能定位

实现首页系统统计数据的查询接口，支撑前端 HomeView 页面的统计卡片展示，数据来源于 system_stats 表，与前端 stats 数组字段对齐。

#### 技术要求

- 接口返回数据需与前端 HomeView 中的 stats 数组结构完全匹配，包含 value、label、icon、iconClass 等字段。

#### 详细实现需求

1. 核心接口设计（1 个接口）：
   - 系统统计数据查询接口：
     - 路径：`/api/system/stats`；方法：`GET`；无请求参数。
     - 逻辑：查询 system_stats 表所有记录，按 stat_name 分组返回，格式化为前端需要的 stats 数组格式。
     - 返回：`code=200, data={"stats": [统计数组]}`，统计数组包含检测次数、干预次数、参与设备、模型准确率等。

2. 数据格式处理：将数据库中的 stat_name、stat_value、stat_unit 转换为前端需要的格式，确保与 HomeView 中的静态数据格式一致。

#### 输出限制

- 输出接口路由代码（`routers/system.py`），包含数据格式转换逻辑。
- 接口返回的统计数据需与前端首页展示的统计卡片完全匹配。

## 三、用户信息管理后端功能实现

### 提示词 3：用户信息 CRUD 接口实现

#### 功能定位

实现用户信息查询、修改、头像上传（模拟）的后端接口，支撑前端用户信息页面的动态交互，数据持久化到 user 表，与前端 Pinia 状态同步。

#### 技术要求

- 接口参数校验：使用 FastAPI `Pydantic` 或 Flask `request` 校验请求参数；头像上传仅保存文件路径（本地存储，不涉及云存储）；返回数据与前端 `userViewState` 字段对齐。

#### 详细实现需求

1. 核心接口设计（4 个接口）：

   - 用户信息查询接口

     ：

     - 路径：`/api/user/info`；方法：`GET`；请求参数：`user_id`（Query 参数，非空）。
     - 逻辑：根据 `user_id` 查询 user 表，返回用户信息（`username`/`student_id`/`avatar`/`detection_count`/`intervention_count`）；若用户不存在，返回 `code=404, msg="用户不存在"`。

   - 用户信息修改接口

     ：

     - 路径：`/api/user/update`；方法：`PUT`；请求体：`user_id`（非空）、`username`（非空）、`student_id`（唯一）。
     - 逻辑：校验 `student_id` 是否与其他用户重复，更新 user 表对应字段，返回 `code=200, msg="信息修改成功", data=更新后用户信息`；参数不完整返回 `code=400, msg="参数缺失"`。

   - 头像上传接口（模拟）

     ：

     - 路径：`/api/user/avatar/upload`；方法：`POST`；请求参数：`user_id`（Form 参数）、`avatar`（File 参数，支持 jpg/png）。
     - 逻辑：将头像文件保存到后端 `static/avatar/` 目录，更新 user 表 `avatar` 字段为文件路径（如 `/static/avatar/1.jpg`），返回 `code=200, msg="头像上传成功", data={"avatar_url": 路径}`；文件格式错误返回 `code=400, msg="仅支持 jpg/png 格式"`。

   - 用户检测 / 干预次数更新接口

     （支撑前端状态同步）：

     - 路径：`/api/user/count/update`；方法：`PUT`；请求体：`user_id`、`type`（detection/intervention）、`count`（新增次数，默认 1）。
     - 逻辑：根据 `type` 累加 user 表 `detection_count` 或 `intervention_count`，返回 `code=200, msg="次数更新成功"`。

2. 数据校验：所有接口需校验 `user_id` 非空且存在，参数不符合规则时返回明确错误提示；敏感字段（如 `student_id`）需校验唯一性。

#### 输出限制

- 输出接口路由代码（`routers/user.py`）、参数校验模型（`models/schemas.py` 中的 `UserUpdate`/`UserCountUpdate` Pydantic 模型）、文件上传工具函数（`utils/file_upload.py`）。
- 头像文件仅保存到本地静态目录，不涉及分布式存储；接口返回格式与前端预期完全对齐，确保前端可直接赋值给 `userViewState`。

### 提示词 4：用户反馈提交与查询接口实现

#### 功能定位

实现用户反馈表单的提交与历史反馈查询接口，支撑前端反馈页面的提交逻辑，数据持久化到 feedback 表，完成模拟提交闭环。

#### 技术要求

- 接口需校验反馈内容长度（10-500 字）、评分范围（1-5），关联用户 ID 确保数据归属；历史反馈查询支持分页，与前端表单交互逻辑对齐。

#### 详细实现需求

1. 核心接口设计（2 个接口）：

   - 反馈提交接口

     ：

     - 路径：`/api/feedback/submit`；方法：`POST`；请求体：`user_id`（非空）、`feedback_type`（detection/music/function，非空）、`content`（非空，10-500 字）、`score`（1-5，非空）。
     - 逻辑：校验参数合法性（如 `content` 长度），向 feedback 表插入数据，返回 `code=200, msg="反馈提交成功"`；参数不合法返回 `code=400, msg="反馈内容需 10-500 字"`。

   - 历史反馈查询接口

     （支撑前端 “查看历史” 功能，可选）：

     - 路径：`/api/feedback/history`；方法：`GET`；请求参数：`user_id`（Query，非空）、`page`（默认 1）、`page_size`（默认 5）。
     - 逻辑：分页查询 user_id 对应的 feedback 数据，返回 `code=200, data={"total": 总条数, "list": [反馈列表], "page": 当前页, "page_size": 每页条数}`；无数据返回空列表。

2. 数据关联：所有反馈记录需关联 `user_id`，确保后续可追溯；提交时间自动填充当前时间，无需前端传递。

#### 输出限制

- 输出接口路由代码（`routers/feedback.py`）、反馈参数校验模型（`models/schemas.py` 中的 `FeedbackSubmit` 模型），包含分页查询逻辑。
- 不涉及反馈审核功能，仅实现提交与查询；接口返回的反馈列表字段需与前端表格展示字段对齐（如 `feedback_type` 需转换为中文 “脑疲劳检测准确性”）。

## 四、轻音乐推荐后端功能实现

### 提示词 5：音乐数据查询与个性化推荐接口实现

#### 功能定位

实现基于疲劳等级与场景的音乐筛选接口，替代前端静态音乐数据库，支撑前端轻音乐推荐页面的动态推荐逻辑，数据来源于 music 表。

#### 技术要求

- 接口需支持多条件筛选（疲劳等级、音乐类型），返回数据与前端音乐卡片字段对齐（`name`/`singer`/`duration`/`cover_url`/`reason`），无需复杂推荐算法，仅做条件匹配。

#### 详细实现需求

1. 核心接口设计（2 个接口）：

   - 音乐列表筛选接口

     （支撑个性化推荐）：

     - 路径：`/api/music/recommend`；方法：`GET`；请求参数：`fatigue_level`（Query，light/medium/heavy，非空）、`music_type`（Query，可选，如 "piano"）。
     - 逻辑：根据 `fatigue_level` 筛选 music 表中 `fatigue_level` 包含该值的记录（如 `fatigue_level` 字段存储 "light,medium" 则匹配），若传递 `music_type` 则叠加筛选；返回 `code=200, data={"music_list": 筛选后列表}`；无数据返回 `code=200, data={"music_list": []}`（前端触发空状态）。

   - 音乐详情查询接口

     （支撑播放页）：

     - 路径：`/api/music/detail`；方法：`GET`；请求参数：`music_id`（Query，非空）。
     - 逻辑：根据 `music_id` 查询单条音乐详情，返回 `code=200, data=音乐详情`；不存在返回 `code=404, msg="音乐不存在"`。

2. 数据格式处理：`fatigue_level` 字段存储为字符串（如 "light,medium"），筛选时需拆分匹配；`cover_url` 返回完整可访问路径（如 `http://localhost:8000/static/music_cover/1.png`）。

#### 输出限制

- 输出接口路由代码（`routers/music.py`），包含多条件筛选逻辑（字符串拆分、多字段匹配）；默认音乐数据已通过初始化脚本插入 music 表。
- 不涉及真实音频文件存储与播放，仅返回音乐元数据；接口筛选逻辑需与前端 “疲劳等级→推荐” 逻辑完全对齐，确保推荐结果一致。

## 五、场景配置后端功能实现

### 提示词 6：场景配置 CRUD 接口实现

#### 功能定位

实现用户场景的创建、查询、应用、删除接口，支撑前端场景设置页面的交互，数据持久化到 scene 表，与前端 `sceneViewState` 状态同步。

#### 技术要求

- 接口需确保用户自定义场景名称唯一，应用场景时返回关联的音乐类型，支撑前端音乐推荐筛选；系统默认场景不允许删除。

#### 详细实现需求

1. 核心接口设计（4 个接口）：

   - 场景列表查询接口

     ：

     - 路径：`/api/scene/list`；方法：`GET`；请求参数：`user_id`（Query，非空）。
     - 逻辑：查询 user_id 对应的所有场景（含系统默认场景 `is_default=1`），返回 `code=200, data={"scene_list": [场景列表]}`；场景列表字段包含 `id`/`scene_name`/`music_type`/`is_default`/`create_time`。

   - 场景创建接口

     ：

     - 路径：`/api/scene/create`；方法：`POST`；请求体：`user_id`（非空）、`scene_name`（非空）、`music_type`（非空，natural/piano/whitenoise/mix）。
     - 逻辑：校验 user_id 下是否存在同名场景，不存在则插入 scene 表（`is_default=0`），返回 `code=200, msg="场景创建成功", data=新场景信息`；同名返回 `code=400, msg="场景名称已存在"`。

   - 场景应用接口

     （支撑前端 “应用场景” 功能）：

     - 路径：`/api/scene/apply`；方法：`GET`；请求参数：`scene_id`（Query，非空）、`user_id`（Query，非空）。
     - 逻辑：校验场景是否归属该用户（或为系统默认场景），存在则返回 `code=200, data={"scene_name": 场景名, "music_type": 音乐类型}`；不存在返回 `code=404, msg="场景不存在"`。

   - 场景删除接口

     （仅允许删除自定义场景）：

     - 路径：`/api/scene/delete`；方法：`DELETE`；请求参数：`scene_id`（Query，非空）、`user_id`（Query，非空）。
     - 逻辑：校验场景 `is_default=0` 且归属该用户，存在则删除，返回 `code=200, msg="场景删除成功"`；系统默认场景返回 `code=403, msg="不允许删除默认场景"`。

2. 权限控制：仅允许用户操作自己创建的场景（`is_default=0`），系统默认场景（`is_default=1`）仅允许查询与应用，不允许修改 / 删除。

#### 输出限制

- 输出接口路由代码（`routers/scene.py`）、场景参数校验模型（`models/schemas.py` 中的 `SceneCreate` 模型），包含场景归属校验逻辑。
- 接口返回的 `music_type` 需与音乐推荐接口的 `music_type` 参数对齐，确保应用场景后可直接触发音乐筛选。

## 六、通用功能与错误处理

### 提示词 7：后端通用错误处理与日志配置

#### 功能定位

实现后端所有接口的统一错误处理（如数据库异常、参数错误）、请求日志记录，确保接口稳定性，便于问题排查，与前端提示风格一致。

#### 技术要求

- 错误处理：捕获数据库异常、请求参数异常，返回统一格式错误响应；日志记录：记录请求路径、参数、响应结果到本地日志文件，按日期分割。

#### 详细实现需求

1. 统一错误处理：
   - 定义全局异常处理器（FastAPI 用 `@app.exception_handler`，Flask 用 `@app.errorhandler`），捕获 `SQLAlchemyError`（数据库异常）、`ValidationError`（参数校验异常）、`HTTPException`（自定义 HTTP 错误）。
   - 数据库异常返回 `code=500, msg="数据库操作失败，请重试"`；参数校验异常返回 `code=400, msg=具体错误信息`；404 异常返回 `code=404, msg="请求资源不存在"`。
2. 日志配置：
   - 在 `utils/log.py` 中配置日志，日志级别为 `INFO`，格式包含 “时间 - 请求方法 - 路径 - 参数 - 响应码”，日志文件保存到 `logs/` 目录，按 “YYYY-MM-DD.log” 命名。
   - 所有接口请求需记录日志（如 `2024-10-10 16:00:00 - GET - /api/user/info - user_id=1 - 200`），便于排查前端请求问题。

#### 输出限制

- 输出全局异常处理器代码（`main.py` 中添加）、日志配置代码（`utils/log.py`），确保所有接口异常均能被捕获并返回统一格式响应。
- 不涉及复杂日志分析，仅实现基础请求记录与错误捕获，日志文件路径与项目目录对齐。